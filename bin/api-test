#!/usr/bin/env ruby
#
# Copyright (C) 2010-2016 dtk contributors
#
# This file is part of the dtk project.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
require 'pp'
require 'byebug'
unless service_name = ARGV[0] 
  puts "Usage: api-test SERVICE-NAME"
  exit 1
end
module_version = '0.5.0'
assembly_name  = 'lab'
lab_user       = 'test-lab-user1'
linux_user     = 'rich'

should_uninstall_service = false
#should_uninstall_service = true

require_relative '../lib/dtk_client'
require_relative('api_test_driver')

driver = DTK::ApiTestDriver.new(service_name)
puts "------------------------\n"
puts "Checking if service exists"
if service_exists = driver.service_exists?
  puts "Service exists so not staging service\n"
else
  puts "------------------------\n"
  puts "Staging service\n"
  driver.stage(module_version, assembly_name)
end

puts "------------------------\n"
puts "Setting attribute lab_user to '#{lab_user}'\n"
driver.set_service_attribute('ubuntu/workshop::instance[lab]/lab_user', lab_user)

puts "------------------------\n"
puts "Setting attribute linux_user to '#{linux_user}'\n"
driver.set_service_attribute('ubuntu/workshop::instance[lab]/linux_user', linux_user)

puts "------------------------\n"
puts "check violations; fail on error"
driver.fail_on_violations

puts "------------------------\n"
puts "converge"
driver.converge

puts "------------------------\n"
puts "wait until complete"
end_state = driver.wait_until_complete
puts "Ended with state '#{end_state}'\n"

if should_uninstall_service
  puts "------------------------\n"
  puts "Unintalling service\n"
  driver.uninstall_service
end
